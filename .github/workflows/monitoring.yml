name: Repository Monitoring

on:
  schedule:
    - cron: '0 9 * * 1-5'  # ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ Ð´ÐµÐ½ÑŒ Ð² 9:00
  workflow_dispatch:

jobs:
  health-check:
    name: Repository Health Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Check repository health
      id: health-check
      run: |
        echo "# Repository Health Report" > health-report.md
        echo "" >> health-report.md
        echo "## Basic Information" >> health-report.md
        echo "" >> health-report.md
        echo "- **Repository:** ${{ github.repository }}" >> health-report.md
        echo "- **Last Check:** $(date)" >> health-report.md
        echo "- **Branch:** ${{ github.ref }}" >> health-report.md
        echo "" >> health-report.md
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        REPO_SIZE=$(du -sh . | cut -f1)
        echo "- **Repository Size:** $REPO_SIZE" >> health-report.md
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²
        FILE_COUNT=$(find . -type f | wc -l)
        echo "- **Total Files:** $FILE_COUNT" >> health-report.md
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð²
        COMMIT_COUNT=$(git rev-list --count HEAD)
        echo "- **Total Commits:** $COMMIT_COUNT" >> health-report.md
        
        echo "" >> health-report.md
        echo "## Dependencies Status" >> health-report.md
        echo "" >> health-report.md
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ npm Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        echo "### Node.js Dependencies" >> health-report.md
        npm outdated --json > npm-outdated.json || echo "{}" > npm-outdated.json
        NPM_OUTDATED_COUNT=$(jq 'keys | length' npm-outdated.json)
        echo "- **Outdated npm packages:** $NPM_OUTDATED_COUNT" >> health-report.md
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Rust Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        echo "" >> health-report.md
        echo "### Rust Dependencies" >> health-report.md
        cd src-tauri
        cargo outdated --root > cargo-outdated.txt 2>/dev/null || echo "No outdated dependencies" > cargo-outdated.txt
        cd ..
        
        echo "" >> health-report.md
        echo "## Security Status" >> health-report.md
        echo "" >> health-report.md
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ npm Ð°ÑƒÐ´Ð¸Ñ‚
        npm audit --audit-level=moderate > npm-audit.txt 2>&1 || echo "No vulnerabilities found" > npm-audit.txt
        if grep -q "found" npm-audit.txt; then
          echo "- **npm vulnerabilities:** Found" >> health-report.md
        else
          echo "- **npm vulnerabilities:** None" >> health-report.md
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Rust Ð°ÑƒÐ´Ð¸Ñ‚
        cd src-tauri
        cargo audit > cargo-audit.txt 2>&1 || echo "No vulnerabilities found" > cargo-audit.txt
        cd ..
        if grep -q "found" cargo-audit.txt; then
          echo "- **Rust vulnerabilities:** Found" >> health-report.md
        else
          echo "- **Rust vulnerabilities:** None" >> health-report.md
        fi
        
        echo "" >> health-report.md
        echo "## Build Status" >> health-report.md
        echo "" >> health-report.md
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ
        if npm run build > build-log.txt 2>&1; then
          echo "- **Frontend build:** âœ… Success" >> health-report.md
        else
          echo "- **Frontend build:** âŒ Failed" >> health-report.md
        fi
        
        cd src-tauri
        if cargo check > cargo-check.txt 2>&1; then
          echo "- **Rust check:** âœ… Success" >> health-report.md
        else
          echo "- **Rust check:** âŒ Failed" >> health-report.md
        fi
        cd ..
        
        echo "" >> health-report.md
        echo "## Recent Activity" >> health-report.md
        echo "" >> health-report.md
        
        # ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹
        echo "### Recent Commits" >> health-report.md
        git log --oneline -5 >> health-report.md
        
        echo "" >> health-report.md
        echo "## Recommendations" >> health-report.md
        echo "" >> health-report.md
        
        # Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸
        if [ $NPM_OUTDATED_COUNT -gt 5 ]; then
          echo "- âš ï¸ Consider updating npm dependencies" >> health-report.md
        fi
        
        if grep -q "found" npm-audit.txt || grep -q "found" cargo-audit.txt; then
          echo "- ðŸ”’ Security vulnerabilities detected" >> health-report.md
        fi
        
        if [ $FILE_COUNT -gt 1000 ]; then
          echo "- ðŸ“ Large repository, consider cleanup" >> health-report.md
        fi

    - name: Upload health report
      uses: actions/upload-artifact@v4
      with:
        name: health-report-$(date +%Y%m%d)
        path: health-report.md
        retention-days: 30

  workflow-status:
    name: Workflow Status Check
    runs-on: ubuntu-latest
    permissions:
      actions: read

    steps:
    - name: Check workflow status
      run: |
        echo "# Workflow Status Report" > workflow-status.md
        echo "" >> workflow-status.md
        echo "## Recent Workflow Runs" >> workflow-status.md
        echo "" >> workflow-status.md
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… workflow runs
        # Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ÐºÑƒ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ñ‡ÐµÑ€ÐµÐ· GitHub API
        
        echo "- **Build workflow:** Check manually" >> workflow-status.md
        echo "- **Test workflow:** Check manually" >> workflow-status.md
        echo "- **Security workflow:** Check manually" >> workflow-status.md
        echo "- **Release workflow:** Check manually" >> workflow-status.md

    - name: Upload workflow status
      uses: actions/upload-artifact@v4
      with:
        name: workflow-status-$(date +%Y%m%d)
        path: workflow-status.md
        retention-days: 30

  performance-metrics:
    name: Performance Metrics
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Measure build performance
      run: |
        echo "# Performance Metrics" > performance-report.md
        echo "" >> performance-report.md
        echo "## Build Performance" >> performance-report.md
        echo "" >> performance-report.md
        
        # Ð˜Ð·Ð¼ÐµÑ€ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸ frontend
        echo "### Frontend Build Time" >> performance-report.md
        START_TIME=$(date +%s)
        npm run build
        END_TIME=$(date +%s)
        BUILD_TIME=$((END_TIME - START_TIME))
        echo "- **Build time:** ${BUILD_TIME} seconds" >> performance-report.md
        
        # Ð˜Ð·Ð¼ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ ÑÐ±Ð¾Ñ€ÐºÐ¸
        if [ -d "dist" ]; then
          BUILD_SIZE=$(du -sh dist | cut -f1)
          echo "- **Build size:** $BUILD_SIZE" >> performance-report.md
        fi
        
        echo "" >> performance-report.md
        echo "### Rust Build Performance" >> performance-report.md
        cd src-tauri
        
        # Ð˜Ð·Ð¼ÐµÑ€ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Rust
        START_TIME=$(date +%s)
        cargo check
        END_TIME=$(date +%s)
        CHECK_TIME=$((END_TIME - START_TIME))
        echo "- **Check time:** ${CHECK_TIME} seconds" >> performance-report.md
        
        # Ð˜Ð·Ð¼ÐµÑ€ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
        START_TIME=$(date +%s)
        cargo test --no-run
        END_TIME=$(date +%s)
        TEST_TIME=$((END_TIME - START_TIME))
        echo "- **Test compilation time:** ${TEST_TIME} seconds" >> performance-report.md
        
        cd ..
        
        echo "" >> performance-report.md
        echo "## Recommendations" >> performance-report.md
        echo "" >> performance-report.md
        
        if [ $BUILD_TIME -gt 60 ]; then
          echo "- â±ï¸ Frontend build is slow, consider optimization" >> performance-report.md
        fi
        
        if [ $CHECK_TIME -gt 30 ]; then
          echo "- â±ï¸ Rust check is slow, consider optimization" >> performance-report.md
        fi

    - name: Upload performance report
      uses: actions/upload-artifact@v4
      with:
        name: performance-report-$(date +%Y%m%d)
        path: performance-report.md
        retention-days: 30

name: Notifications

on:
  workflow_run:
    workflows: ["Build", "Release", "Test", "Security"]
    types: [completed]

jobs:
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'skipped' }}

    steps:
    - name: Check workflow status
      id: check-status
      run: |
        if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
        fi
        
        echo "workflow=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
        echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT

    - name: Notify on success
      if: steps.check-status.outputs.status == 'success'
      run: |
        echo "‚úÖ Workflow '${{ steps.check-status.outputs.workflow }}' completed successfully on branch '${{ steps.check-status.outputs.branch }}'"
        
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Slack, Discord, Telegram –∏ —Ç.–¥.
        # –ü—Ä–∏–º–µ—Ä –¥–ª—è Slack:
        # curl -X POST -H 'Content-type: application/json' \
        #   --data "{\"text\":\"‚úÖ Workflow '${{ steps.check-status.outputs.workflow }}' completed successfully on branch '${{ steps.check-status.outputs.branch }}'\"}" \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Notify on failure
      if: steps.check-status.outputs.status == 'failure'
      run: |
        echo "‚ùå Workflow '${{ steps.check-status.outputs.workflow }}' failed on branch '${{ steps.check-status.outputs.branch }}'"
        
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
        # –ü—Ä–∏–º–µ—Ä –¥–ª—è Slack:
        # curl -X POST -H 'Content-type: application/json' \
        #   --data "{\"text\":\"‚ùå Workflow '${{ steps.check-status.outputs.workflow }}' failed on branch '${{ steps.check-status.outputs.branch }}'. Check: ${{ github.event.workflow_run.html_url }}\"}" \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —Ä–µ–ª–∏–∑–æ–≤
  release-notify:
    name: Release Notifications
    runs-on: ubuntu-latest
    if: github.event.workflow_run.name == 'Release' && github.event.workflow_run.conclusion == 'success'

    steps:
    - name: Get release info
      id: release-info
      run: |
        echo "tag=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
        echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Notify release
      run: |
        echo "üéâ New release: ${{ steps.release-info.outputs.version }}"
        
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–µ–ª–∏–∑–µ
        # –ü—Ä–∏–º–µ—Ä –¥–ª—è Slack:
        # curl -X POST -H 'Content-type: application/json' \
        #   --data "{\"text\":\"üéâ New release: ${{ steps.release-info.outputs.version }} is now available!\"}" \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è security issues
  security-notify:
    name: Security Notifications
    runs-on: ubuntu-latest
    if: github.event.workflow_run.name == 'Security' && github.event.workflow_run.conclusion == 'failure'

    steps:
    - name: Notify security issue
      run: |
        echo "üö® Security issue detected in workflow '${{ github.event.workflow_run.name }}'"
        
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        # –ü—Ä–∏–º–µ—Ä –¥–ª—è Slack:
        # curl -X POST -H 'Content-type: application/json' \
        #   --data "{\"text\":\"üö® Security issue detected! Check: ${{ github.event.workflow_run.html_url }}\"}" \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}
